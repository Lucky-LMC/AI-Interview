# AIæ™ºèƒ½é¢è¯•è¾…åŠ©ç³»ç»ŸV1.0ï¼Œä½œè€…åˆ˜æ¢¦ç•…
"""
ç§æœ‰çŸ¥è¯†åº“å·¥å…· - ç”¨äºæ£€ç´¢é¢è¯•ç›¸å…³å†…éƒ¨æ–‡æ¡£
"""
from langchain_core.tools import tool
from typing import Optional

# æ¨¡æ‹Ÿçš„ç§æœ‰çŸ¥è¯†åº“ï¼ˆå®é™…é¡¹ç›®ä¸­å¯ä»¥æ¥å…¥å‘é‡æ•°æ®åº“å¦‚Chromaã€Pineconeç­‰ï¼‰
KNOWLEDGE_BASE = {
    "é¢è¯•æµç¨‹": """
    æˆ‘ä»¬çš„é¢è¯•æµç¨‹é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š
    1. **ç®€å†ç­›é€‰**ï¼šHR ä¼šæ ¹æ®å²—ä½è¦æ±‚ç­›é€‰ç®€å†
    2. **ç”µè¯é¢è¯•**ï¼šåˆæ­¥äº†è§£å€™é€‰äººçš„åŸºæœ¬æƒ…å†µå’Œæ„å‘
    3. **æŠ€æœ¯é¢è¯•**ï¼š1-2 è½®æŠ€æœ¯é¢è¯•ï¼Œè€ƒå¯Ÿä¸“ä¸šæŠ€èƒ½
    4. **HR é¢è¯•**ï¼šäº†è§£è½¯å®åŠ›ã€è–ªèµ„æœŸæœ›ç­‰
    5. **Offer å‘æ”¾**ï¼šé€šè¿‡å 3-5 ä¸ªå·¥ä½œæ—¥å†…å‘æ”¾ Offer
    
    é¢è¯•å‘¨æœŸé€šå¸¸ä¸º 1-2 å‘¨ã€‚
    """,
    
    "STARæ³•åˆ™": """
    STAR æ³•åˆ™æ˜¯é¢è¯•ä¸­å›ç­”è¡Œä¸ºé—®é¢˜çš„ç»å…¸æ–¹æ³•ï¼š
    - **S (Situation)**ï¼šæè¿°å½“æ—¶çš„æƒ…å†µå’ŒèƒŒæ™¯
    - **T (Task)**ï¼šè¯´æ˜ä½ éœ€è¦å®Œæˆçš„ä»»åŠ¡æˆ–æŒ‘æˆ˜
    - **A (Action)**ï¼šè¯¦ç»†è¯´æ˜ä½ é‡‡å–çš„å…·ä½“è¡ŒåŠ¨
    - **R (Result)**ï¼šå±•ç¤ºæœ€ç»ˆçš„æˆæœå’Œæ”¶è·
    
    ç¤ºä¾‹ï¼š
    "åœ¨ä¸Šä¸€å®¶å…¬å¸ï¼Œæˆ‘ä»¬çš„é¡¹ç›®é‡åˆ°æ€§èƒ½ç“¶é¢ˆ (S)ã€‚ä½œä¸ºæŠ€æœ¯è´Ÿè´£äººï¼Œæˆ‘éœ€è¦åœ¨ä¸€å‘¨å†…ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ (T)ã€‚
    æˆ‘é€šè¿‡ä»£ç åˆ†æå®šä½åˆ°æ•°æ®åº“æŸ¥è¯¢é—®é¢˜ï¼Œé‡æ–°è®¾è®¡äº†ç´¢å¼•å¹¶å¼•å…¥ç¼“å­˜æœºåˆ¶ (A)ã€‚
    æœ€ç»ˆå“åº”æ—¶é—´ä» 2 ç§’é™ä½åˆ° 200msï¼Œç”¨æˆ·æ»¡æ„åº¦æå‡äº† 30% (R)ã€‚"
    """,
    
    "æŠ€æœ¯é¢è¯•å‡†å¤‡": """
    æŠ€æœ¯é¢è¯•çš„å‡†å¤‡å»ºè®®ï¼š
    1. **åŸºç¡€çŸ¥è¯†**ï¼šç¡®ä¿æ•°æ®ç»“æ„ã€ç®—æ³•ã€æ“ä½œç³»ç»Ÿç­‰åŸºç¡€æ‰å®
    2. **é¡¹ç›®ç»éªŒ**ï¼šå‡†å¤‡ 2-3 ä¸ªæœ‰æ·±åº¦çš„é¡¹ç›®æ¡ˆä¾‹ï¼Œèƒ½è®²æ¸…æ¥šæŠ€æœ¯é€‰å‹å’Œéš¾ç‚¹
    3. **ç¼–ç¨‹èƒ½åŠ›**ï¼šå¤šåˆ· LeetCodeï¼Œé‡ç‚¹æ˜¯ä¸­ç­‰éš¾åº¦é¢˜
    4. **ç³»ç»Ÿè®¾è®¡**ï¼šäº†è§£å¸¸è§çš„æ¶æ„æ¨¡å¼ï¼Œå¦‚å¾®æœåŠ¡ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰
    5. **æ²Ÿé€šèƒ½åŠ›**ï¼šæ¸…æ™°è¡¨è¾¾æ€è·¯ï¼Œå±•ç°æ€ç»´è¿‡ç¨‹
    
    é¢è¯•æ—¶è®°å¾—å¸¦ç¬”è®°æœ¬å’Œç®€å†å‰¯æœ¬ã€‚
    """,
    
    "å¸¸è§é—®é¢˜": """
    å¸¸è§é¢è¯•é—®é¢˜åŠåº”å¯¹ç­–ç•¥ï¼š
    
    1. **è‡ªæˆ‘ä»‹ç»**ï¼š
       - ç®€æ˜æ‰¼è¦ï¼Œæ§åˆ¶åœ¨ 2 åˆ†é’Ÿå†…
       - çªå‡ºä¸å²—ä½ç›¸å…³çš„ç»éªŒ
       - ä»¥äº®ç‚¹ç»“å°¾ï¼Œå¼•å¯¼é¢è¯•å®˜æé—®
    
    2. **ç¦»èŒåŸå› **ï¼š
       - ç§¯ææ­£é¢ï¼Œä¸æŠ±æ€¨å‰å…¬å¸
       - å¼ºè°ƒä¸ªäººæˆé•¿å’ŒèŒä¸šå‘å±•
    
    3. **èŒä¸šè§„åˆ’**ï¼š
       - å±•ç°é•¿æœŸç¨³å®šæ€§
       - è¯´æ˜å¦‚ä½•ä¸å…¬å¸å‘å±•å¯¹é½
    
    4. **è–ªèµ„æœŸæœ›**ï¼š
       - æå‰äº†è§£å¸‚åœºè¡Œæƒ…
       - ç»™å‡ºåˆç†èŒƒå›´ï¼Œç•™æœ‰è°ˆåˆ¤ç©ºé—´
    """,
    
    "ç®€å†ä¼˜åŒ–": """
    ç®€å†ä¼˜åŒ–çš„æ ¸å¿ƒè¦ç‚¹ï¼š
    
    1. **æ ¼å¼**ï¼š
       - ä½¿ç”¨ PDF æ ¼å¼ï¼Œç¡®ä¿è·¨å¹³å°æ˜¾ç¤ºä¸€è‡´
       - å­—ä½“é€‰æ‹©ï¼šé»‘ä½“/å¾®è½¯é›…é»‘ï¼ˆæ ‡é¢˜ï¼‰ï¼Œå®‹ä½“ï¼ˆæ­£æ–‡ï¼‰
       - é¡µæ•°ï¼š1-2 é¡µæœ€ä½³
    
    2. **å†…å®¹ç»“æ„**ï¼š
       - ä¸ªäººä¿¡æ¯ï¼ˆå§“åã€è”ç³»æ–¹å¼ã€æ±‚èŒæ„å‘ï¼‰
       - æ•™è‚²èƒŒæ™¯
       - å·¥ä½œç»å†ï¼ˆé‡ç‚¹ï¼ä½¿ç”¨ STAR æ³•åˆ™æè¿°ï¼‰
       - é¡¹ç›®ç»éªŒ
       - æŠ€èƒ½æ¸…å•
    
    3. **å…³é”®è¯ä¼˜åŒ–**ï¼š
       - é’ˆå¯¹å²—ä½ JD æå–å…³é”®è¯
       - åœ¨ç®€å†ä¸­è‡ªç„¶èå…¥è¿™äº›å…³é”®è¯
    
    4. **é‡åŒ–æˆæœ**ï¼š
       - ä½¿ç”¨æ•°å­—è¯´è¯ï¼šæå‡ 30%ã€èŠ‚çœ 20 å°æ—¶/å‘¨
       - é¿å…ç©ºæ´çš„å½¢å®¹è¯
    """
}


@tool
def search_knowledge_base(query: str) -> str:
    """
    ä»ç§æœ‰çŸ¥è¯†åº“ä¸­æ£€ç´¢é¢è¯•ç›¸å…³ä¿¡æ¯ã€‚
    
    Args:
        query: ç”¨æˆ·çš„é—®é¢˜æˆ–æŸ¥è¯¢å…³é”®è¯
        
    Returns:
        str: æ£€ç´¢åˆ°çš„ç›¸å…³å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™è¿”å› "æ— ç›¸å…³ä¿¡æ¯"
    """
    print(f"[search_knowledge_base] å¼€å§‹æ£€ç´¢ï¼ŒæŸ¥è¯¢: {query}")
    
    # ç®€å•çš„å…³é”®è¯åŒ¹é…ï¼ˆå®é™…å¯ä»¥ç”¨å‘é‡æ£€ç´¢æˆ–æ›´å¤æ‚çš„è¯­ä¹‰åŒ¹é…ï¼‰
    query_lower = query.lower()
    
    # å…³é”®è¯åˆ°çŸ¥è¯†æ¡ç›®çš„æ˜ å°„
    keyword_mapping = {
        "æµç¨‹": "é¢è¯•æµç¨‹",
        "é˜¶æ®µ": "é¢è¯•æµç¨‹",
        "å‘¨æœŸ": "é¢è¯•æµç¨‹",
        "star": "STARæ³•åˆ™",
        "è¡Œä¸ºé—®é¢˜": "STARæ³•åˆ™",
        "æŠ€æœ¯é¢è¯•": "æŠ€æœ¯é¢è¯•å‡†å¤‡",
        "å‡†å¤‡": "æŠ€æœ¯é¢è¯•å‡†å¤‡",
        "ç®—æ³•": "æŠ€æœ¯é¢è¯•å‡†å¤‡",
        "è‡ªæˆ‘ä»‹ç»": "å¸¸è§é—®é¢˜",
        "ç¦»èŒ": "å¸¸è§é—®é¢˜",
        "èŒä¸šè§„åˆ’": "å¸¸è§é—®é¢˜",
        "è–ªèµ„": "å¸¸è§é—®é¢˜",
        "ç®€å†": "ç®€å†ä¼˜åŒ–",
        "ä¼˜åŒ–": "ç®€å†ä¼˜åŒ–",
        "æ ¼å¼": "ç®€å†ä¼˜åŒ–"
    }
    
    # æŸ¥æ‰¾åŒ¹é…çš„çŸ¥è¯†æ¡ç›®
    matched_content = []
    matched_keys = []
    for keyword, kb_key in keyword_mapping.items():
        if keyword in query_lower:
            if kb_key in KNOWLEDGE_BASE and KNOWLEDGE_BASE[kb_key] not in matched_content:
                matched_content.append(KNOWLEDGE_BASE[kb_key])
                matched_keys.append(kb_key)
    
    if matched_content:
        print(f"[search_knowledge_base] âœ… æ‰¾åˆ° {len(matched_content)} æ¡åŒ¹é…å†…å®¹: {', '.join(matched_keys)}")
        return "\n\n".join(matched_content)
    else:
        print(f"[search_knowledge_base] âŒ æœªæ‰¾åˆ°ç›¸å…³å†…å®¹ï¼Œè¿”å›'æ— ç›¸å…³ä¿¡æ¯'")
        return "æ— ç›¸å…³ä¿¡æ¯"


# å¯¼å…¥ Tavily æœç´¢å·¥å…·ï¼ˆä½œä¸ºå…œåº•ï¼‰
@tool
def tavily_search(query: str) -> str:
    """
    ä½¿ç”¨ Tavily è”ç½‘æœç´¢æœ€æ–°çš„é¢è¯•ç›¸å…³ä¿¡æ¯ã€‚
    
    Args:
        query: æœç´¢æŸ¥è¯¢
        
    Returns:
        str: æœç´¢ç»“æœ
    """
    from backend.config import TAVILY_API_KEY
    from tavily import TavilyClient

    print(f"[tavily_search] ğŸŒ è§¦å‘è”ç½‘æœç´¢ï¼ˆå…œåº•æœºåˆ¶ï¼‰ï¼ŒæŸ¥è¯¢: {query}")

    if not TAVILY_API_KEY:
        print("[tavily_search] âŒ æœªé…ç½® TAVILY_API_KEY")
        return "æœç´¢å¤±è´¥: æœªé…ç½® TAVILY_API_KEY"

    try:
        tavily = TavilyClient(api_key=TAVILY_API_KEY)
        
        # æ‰§è¡Œæœç´¢
        response = tavily.search(query=query, search_depth="basic", max_results=3)
        results = response.get("results", [])
        
        if results:
            # æ•´ç†æœç´¢ç»“æœ
            search_results = []
            for res in results:
                search_results.append(f"- [{res['title']}]({res['url']})\n  {res['content'][:200]}...")
            
            result_text = "\n\n".join(search_results)
            print(f"[tavily_search] âœ… æ‰¾åˆ° {len(results)} ä¸ªè”ç½‘ç»“æœ")
            return f"ã€è”ç½‘æœç´¢ç»“æœã€‘\n{result_text}"
        else:
            print(f"[tavily_search] âš ï¸ æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯")
            return f"æœªæ‰¾åˆ°å…³äº {query} çš„ç›¸å…³ä¿¡æ¯"
            
    except Exception as e:
        print(f"[tavily_search] âŒ æœç´¢å¤±è´¥: {e}")
        return f"æœç´¢å¤±è´¥: {str(e)}"


# å¯¼å‡ºå·¥å…·åˆ—è¡¨ï¼ˆé¡ºåºå¾ˆé‡è¦ï¼ä¼˜å…ˆä½¿ç”¨çŸ¥è¯†åº“ï¼‰
customer_service_tools = [search_knowledge_base, tavily_search]
