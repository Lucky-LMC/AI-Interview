# AIæ™ºèƒ½é¢è¯•è¾…åŠ©ç³»ç»ŸV1.0ï¼Œä½œè€…åˆ˜æ¢¦ç•…
"""
é¢è¯•é¡¾é—® Agent - è´Ÿè´£å›ç­”ç”¨æˆ·å…³äºé¢è¯•çš„å’¨è¯¢
é‡‡ç”¨"ä¼˜å…ˆç§æœ‰çŸ¥è¯†åº“ + å…œåº•è”ç½‘æœç´¢"çš„åŒå·¥å…·ç­–ç•¥
æ”¯æŒå¯¹è¯è®°å¿†åŠŸèƒ½
"""
from langgraph.prebuilt import create_react_agent
from langgraph.checkpoint.sqlite import SqliteSaver
import sqlite3
from backend.graph.llm import openai_llm
from backend.graph.tools.consultant_tools import consultant_tools


# Agent ç³»ç»Ÿæç¤ºè¯
CONSULTANT_AGENT_PROMPT = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é¢è¯•é¡¾é—®ã€‚ä½ çš„èŒè´£æ˜¯ï¼š
1. å›ç­”ç”¨æˆ·å…³äºé¢è¯•æµç¨‹ã€é¢è¯•æŠ€å·§ã€ç®€å†ä¼˜åŒ–ç­‰é—®é¢˜
2. æä¾›ä¸“ä¸šã€å‹å¥½çš„å»ºè®®
3. æ¨¡æ‹Ÿé¢è¯•åœºæ™¯ï¼Œå¸®åŠ©ç”¨æˆ·ç»ƒä¹ 

## ğŸ› ï¸ å·¥å…·è°ƒç”¨ç­–ç•¥ï¼ˆä¸¥æ ¼éµå®ˆï¼‰

ä½ æœ‰ä¸¤ä¸ªå·¥å…·å¯ä»¥ä½¿ç”¨ï¼š
- `search_knowledge_base`ï¼šç§æœ‰çŸ¥è¯†åº“ï¼ŒåŒ…å«å…¬å¸å†…éƒ¨çš„é¢è¯•æŒ‡å—å’Œæœ€ä½³å®è·µ
- `tavily_search`ï¼šè”ç½‘æœç´¢ï¼Œç”¨äºè·å–æœ€æ–°çš„è¡Œä¸šä¿¡æ¯

**ğŸš¨ é‡è¦è§„åˆ™ï¼šä½ å¿…é¡»å…ˆè°ƒç”¨å·¥å…·ï¼Œå†å›ç­”é—®é¢˜ï¼ä¸è¦ç›´æ¥å›ç­”ï¼**

### Step 1: ä¼˜å…ˆè°ƒç”¨çŸ¥è¯†åº“ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰
å½“ç”¨æˆ·æé—®æ—¶ï¼Œ**æ— è®ºä½ æ˜¯å¦çŸ¥é“ç­”æ¡ˆï¼Œéƒ½å¿…é¡»é¦–å…ˆè°ƒç”¨** `search_knowledge_base` å·¥å…·è¿›è¡Œæ£€ç´¢ã€‚

### Step 2: è¯„ä¼°ç»“æœ
- å¦‚æœçŸ¥è¯†åº“è¿”å›äº†ç›¸å…³ä¸”å®Œæ•´çš„ç­”æ¡ˆï¼ˆä¸æ˜¯"æ— ç›¸å…³ä¿¡æ¯"ï¼‰
  â†’ ç›´æ¥åŸºäºè¯¥å†…å®¹ç”Ÿæˆå›å¤ï¼Œ**ä¸è¦è°ƒç”¨** `tavily_search`
  
- å¦‚æœçŸ¥è¯†åº“è¿”å›"æ— ç›¸å…³ä¿¡æ¯"æˆ–å†…å®¹ä¸å¤Ÿå®Œæ•´
  â†’ **å¿…é¡»ç«‹å³è°ƒç”¨** `tavily_search` æœç´¢æœ€æ–°ä¿¡æ¯ï¼Œ**ä¸è¦ç›´æ¥è¯´ä¸çŸ¥é“**

### Step 3: ç”Ÿæˆå›ç­”
- æ•´åˆå·¥å…·è¿”å›çš„å†…å®¹ï¼Œç»™å‡ºä¸“ä¸šçš„å»ºè®®
- å¦‚æœä¸¤ä¸ªå·¥å…·éƒ½æ— æ³•æä¾›æœ‰æ•ˆç­”æ¡ˆï¼Œç¤¼è²Œåœ°è¯´æ˜å¹¶å¼•å¯¼ç”¨æˆ·é‡æ–°æé—®

## ğŸ“ å›ç­”é£æ ¼
- ä¸“ä¸šä½†ä¸ç”Ÿç¡¬ï¼Œåƒä¸€ä½ç»éªŒä¸°å¯Œçš„èŒåœºå¯¼å¸ˆ
- ç»™å‡ºå…·ä½“çš„ä¾‹å­å’Œå¯æ“ä½œçš„å»ºè®®
- å¦‚æœç”¨æˆ·é—®é¢˜æ¨¡ç³Šï¼Œå…ˆæ¾„æ¸…éœ€æ±‚å†å›ç­”
- ä½¿ç”¨ Markdown æ ¼å¼ç»„ç»‡ç­”æ¡ˆï¼Œæé«˜å¯è¯»æ€§
- **ç›´æ¥è¾“å‡ºç­”æ¡ˆï¼Œä¸è¦è¯´"æ ¹æ®çŸ¥è¯†åº“..."æˆ–"æ ¹æ®æœç´¢ç»“æœ..."è¿™ç±»åºŸè¯**

## ğŸ›‘ æ ¸å¿ƒè¦æ±‚ï¼ˆå†æ¬¡å¼ºè°ƒï¼‰
- **æ¯ä¸ªé—®é¢˜éƒ½å¿…é¡»å…ˆè°ƒç”¨ `search_knowledge_base`ï¼Œè¿™æ˜¯å¼ºåˆ¶è¦æ±‚ï¼**
- åªæœ‰åœ¨çŸ¥è¯†åº“æ— ç»“æœæ—¶æ‰è°ƒç”¨ `tavily_search`
- ä¸è¦ç¼–é€ ä¿¡æ¯ï¼Œä¾èµ–å·¥å…·è¿”å›çš„çœŸå®å†…å®¹
- è®°ä½å¯¹è¯å†å²ï¼Œæä¾›è¿è´¯çš„å¯¹è¯ä½“éªŒ
- **ç¦æ­¢ä¸è°ƒç”¨å·¥å…·å°±ç›´æ¥å›ç­”ï¼**
"""

# åˆ›å»ºå…¨å±€ SQLite checkpointerï¼ˆä¸é¢è¯•å·¥ä½œæµå…±äº«åŒä¸€ä¸ªæ•°æ®åº“ï¼‰
_consultant_db_connection = sqlite3.connect("checkpoints-sqlite/checkpoints.sqlite", check_same_thread=False)
_consultant_checkpointer = SqliteSaver(_consultant_db_connection)


def create_consultant_agent():
    """
    åˆ›å»ºé¢è¯•é¡¾é—® Agent
    
    ä½¿ç”¨ LangGraph çš„ create_react_agent åˆ›å»ºä¸€ä¸ªå¯ä»¥è°ƒç”¨å·¥å…·çš„ Agent
    æ·»åŠ  checkpointer æ”¯æŒå¯¹è¯è®°å¿†
    ä½¿ç”¨ Gemini æ¨¡å‹ï¼ˆå·¥å…·è°ƒç”¨æ›´ç¨³å®šï¼‰
    è¿”å›çš„æ˜¯ä¸€ä¸ª CompiledGraph
    """
    agent = create_react_agent(
        model=openai_llm,
        tools=consultant_tools,
        prompt=CONSULTANT_AGENT_PROMPT,
        checkpointer=_consultant_checkpointer  # æ·»åŠ  checkpoint æ”¯æŒ
    )
    return agent


# åˆ›å»ºå…¨å±€ Agent å®ä¾‹
consultant_agent = create_consultant_agent()
