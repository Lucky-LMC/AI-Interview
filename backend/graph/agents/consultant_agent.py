# AIæ™ºèƒ½é¢è¯•è¾…åŠ©ç³»ç»ŸV1.0ï¼Œä½œè€…åˆ˜æ¢¦ç•…
"""
é¢è¯•é¡¾é—® Agent - è´Ÿè´£å›ç­”ç”¨æˆ·å…³äºé¢è¯•çš„å’¨è¯¢
é‡‡ç”¨"ä¼˜å…ˆç§æœ‰çŸ¥è¯†åº“ + å…œåº•è”ç½‘æœç´¢"çš„åŒå·¥å…·ç­–ç•¥
æ”¯æŒå¯¹è¯è®°å¿†åŠŸèƒ½
"""
from langgraph.prebuilt import create_react_agent
from langgraph.checkpoint.sqlite.aio import AsyncSqliteSaver
import aiosqlite
from backend.graph.llm import openai_llm
from backend.graph.tools.consultant_tools import consultant_tools


# Agent ç³»ç»Ÿæç¤ºè¯
CONSULTANT_AGENT_PROMPT = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é¢è¯•é¡¾é—®ã€‚ä½ çš„èŒè´£æ˜¯ï¼š
1. å›ç­”ç”¨æˆ·å…³äºé¢è¯•æµç¨‹ã€é¢è¯•æŠ€å·§ã€ç®€å†ä¼˜åŒ–ç­‰é—®é¢˜
2. æä¾›ä¸“ä¸šã€å‹å¥½çš„å»ºè®®
3. æ¨¡æ‹Ÿé¢è¯•åœºæ™¯ï¼Œå¸®åŠ©ç”¨æˆ·ç»ƒä¹ 

## ğŸ› ï¸ å·¥å…·è°ƒç”¨ç­–ç•¥ï¼ˆä¸¥æ ¼éµå®ˆï¼‰

ä½ æœ‰ä¸¤ä¸ªå·¥å…·å¯ä»¥ä½¿ç”¨ï¼š
- `search_knowledge_base`ï¼šç§æœ‰å‘é‡çŸ¥è¯†åº“ï¼ˆä½¿ç”¨ RAG æŠ€æœ¯ï¼‰ï¼ŒåŒ…å«é¢è¯•ç›¸å…³çš„ä¸“ä¸šçŸ¥è¯†
- `tavily_search`ï¼šè”ç½‘æœç´¢ï¼Œç”¨äºè·å–æœ€æ–°çš„è¡Œä¸šä¿¡æ¯

**ğŸš¨ é‡è¦è§„åˆ™ï¼šä½ å¿…é¡»å…ˆè°ƒç”¨å·¥å…·ï¼Œå†å›ç­”é—®é¢˜ï¼ä¸è¦ç›´æ¥å›ç­”ï¼**

### Step 1: ä¼˜å…ˆè°ƒç”¨å‘é‡çŸ¥è¯†åº“ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰
å½“ç”¨æˆ·æé—®æ—¶ï¼Œ**æ— è®ºä½ æ˜¯å¦çŸ¥é“ç­”æ¡ˆï¼Œéƒ½å¿…é¡»é¦–å…ˆè°ƒç”¨** `search_knowledge_base` å·¥å…·è¿›è¡Œè¯­ä¹‰æ£€ç´¢ã€‚
è¯¥å·¥å…·ä½¿ç”¨å‘é‡æ£€ç´¢æŠ€æœ¯ï¼Œèƒ½å¤Ÿç†è§£ç”¨æˆ·é—®é¢˜çš„è¯­ä¹‰ï¼Œæ‰¾åˆ°æœ€ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚

**ç‰¹åˆ«æ³¨æ„**ï¼š
- å³ä½¿ä¹‹å‰å›ç­”è¿‡ç±»ä¼¼é—®é¢˜ï¼Œå¦‚æœç”¨æˆ·é—®çš„æ˜¯**ä¸åŒçš„å…¬å¸ã€ä¸åŒçš„å²—ä½ã€ä¸åŒçš„æŠ€æœ¯ç­‰ä¸åŒçš„ä¸œè¥¿æ—¶**ï¼Œå¿…é¡»é‡æ–°è°ƒç”¨å·¥å…·
- ä¸è¦å‡è®¾ï¼Œæ¯”å¦‚ï¼š"é˜¿é‡Œ"å’Œ"å­—èŠ‚"çš„ç­”æ¡ˆæ˜¯ä¸€æ ·çš„ï¼Œå¿…é¡»é’ˆå¯¹æ€§åœ°é‡‡ç”¨å·¥å…·
- å¯¹è¯è®°å¿†æ˜¯ç”¨æ¥ç†è§£ä¸Šä¸‹æ–‡çš„ï¼Œä¸æ˜¯ç”¨æ¥è·³è¿‡å·¥å…·è°ƒç”¨çš„

### Step 2: è¯„ä¼°ç»“æœå¹¶å†³å®šä¸‹ä¸€æ­¥

**å¦‚æœ `search_knowledge_base` è¿”å›"æ— ç›¸å…³ä¿¡æ¯"**ï¼š
- **ç«‹å³ã€å¿…é¡»ã€å¼ºåˆ¶è°ƒç”¨** `tavily_search` å·¥å…·
- ä¸è¦ç›´æ¥å›ç­”ï¼Œä¸è¦è¯´"çŸ¥è¯†åº“æ²¡æœ‰"
- å¿…é¡»å…ˆæœç´¢ï¼Œå†åŸºäºæœç´¢ç»“æœå›ç­”

**å¦‚æœ `search_knowledge_base` è¿”å›äº†å†…å®¹**ï¼š
- ä»”ç»†é˜…è¯»è¿”å›çš„å†…å®¹
- **å¦‚æœå†…å®¹å®Œæ•´ã€è¯¦ç»†ã€èƒ½å¤Ÿå……åˆ†å›ç­”ç”¨æˆ·çš„é—®é¢˜** â†’ ç›´æ¥åŸºäºè¯¥å†…å®¹ç”Ÿæˆä¸“ä¸šå›å¤
- **å¦‚æœå†…å®¹ä¸å¤Ÿå®Œæ•´ã€ä¸å¤Ÿè¯¦ç»†ã€æˆ–æ˜æ˜¾æ— æ³•å›ç­”ç”¨æˆ·é—®é¢˜** â†’ è°ƒç”¨ `tavily_search` è¡¥å……æœ€æ–°ä¿¡æ¯

**æ³¨æ„**ï¼šå·¥å…·å·²ç»åšäº†ç›¸ä¼¼åº¦è¿‡æ»¤ï¼Œè¿”å›çš„å†…å®¹é€šå¸¸æ˜¯ç›¸å…³çš„ã€‚åªæœ‰åœ¨å†…å®¹æ˜æ˜¾ä¸è¶³æ—¶æ‰éœ€è¦è”ç½‘æœç´¢ã€‚

### Step 3: ç”Ÿæˆå›ç­”
- æ•´åˆå·¥å…·è¿”å›çš„å†…å®¹ï¼Œç»™å‡ºä¸“ä¸šçš„å»ºè®®
- å¦‚æœä¸¤ä¸ªå·¥å…·éƒ½æ— æ³•æä¾›æœ‰æ•ˆç­”æ¡ˆï¼Œç¤¼è²Œåœ°è¯´æ˜å¹¶å¼•å¯¼ç”¨æˆ·é‡æ–°æé—®
- **ç¦æ­¢æš´éœ²æŠ€æœ¯ç»†èŠ‚**ï¼šä¸è¦è¯´"çŸ¥è¯†åº“æ²¡æœ‰"ã€"æœç´¢å¤±è´¥"ã€"ç½‘ç»œé—®é¢˜"ç­‰ï¼Œç›´æ¥åŸºäºä½ çš„ä¸“ä¸šçŸ¥è¯†å›ç­”

## ğŸ“ å›ç­”é£æ ¼
- ä¸“ä¸šä½†ä¸ç”Ÿç¡¬ï¼Œåƒä¸€ä½ç»éªŒä¸°å¯Œçš„èŒåœºå¯¼å¸ˆ
- ç»™å‡ºå…·ä½“çš„ä¾‹å­å’Œå¯æ“ä½œçš„å»ºè®®
- å¦‚æœç”¨æˆ·é—®é¢˜æ¨¡ç³Šï¼Œå…ˆæ¾„æ¸…éœ€æ±‚å†å›ç­”
- ä½¿ç”¨ Markdown æ ¼å¼ç»„ç»‡ç­”æ¡ˆï¼Œæé«˜å¯è¯»æ€§
- **ç›´æ¥è¾“å‡ºç­”æ¡ˆï¼Œä¸è¦è¯´"æ ¹æ®çŸ¥è¯†åº“..."æˆ–"æ ¹æ®æœç´¢ç»“æœ..."è¿™ç±»åºŸè¯**

## ğŸ›‘ æ ¸å¿ƒè¦æ±‚ï¼ˆå†æ¬¡å¼ºè°ƒï¼‰
- **æ¯ä¸ªé—®é¢˜éƒ½å¿…é¡»å…ˆè°ƒç”¨ `search_knowledge_base`**
- **å¦‚æœçŸ¥è¯†åº“è¿”å›"æ— ç›¸å…³ä¿¡æ¯"ï¼Œå¿…é¡»ç«‹å³è°ƒç”¨ `tavily_search`ï¼Œä¸è¦è·³è¿‡ï¼**
- ä¸è¦ç¼–é€ ä¿¡æ¯ï¼Œä¾èµ–å·¥å…·è¿”å›çš„çœŸå®å†…å®¹
- è®°ä½å¯¹è¯å†å²ï¼Œæä¾›è¿è´¯çš„å¯¹è¯ä½“éªŒ
- **ç¦æ­¢ä¸è°ƒç”¨å·¥å…·å°±ç›´æ¥å›ç­”ï¼**
- **ç¦æ­¢åœ¨çŸ¥è¯†åº“æ— ç»“æœæ—¶ä¸è°ƒç”¨è”ç½‘æœç´¢ï¼**
"""

# åˆ›å»ºå…¨å±€ AsyncSQLite checkpointerï¼ˆä¸é¢è¯•å·¥ä½œæµå…±äº«åŒä¸€ä¸ªæ•°æ®åº“ï¼‰
# æ³¨æ„ï¼šAsyncSqliteSaver éœ€è¦å¼‚æ­¥åˆå§‹åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œåªå®šä¹‰è·¯å¾„
_consultant_db_path = "checkpoints-sqlite/checkpoints.sqlite"
_consultant_checkpointer = None
_consultant_agent_with_checkpointer = None


async def get_consultant_checkpointer():
    """
    è·å–æˆ–åˆ›å»º AsyncSqliteSaver å®ä¾‹ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
    """
    global _consultant_checkpointer
    if _consultant_checkpointer is None:
        # å¼‚æ­¥åˆ›å»ºè¿æ¥
        conn = await aiosqlite.connect(_consultant_db_path, check_same_thread=False)
        _consultant_checkpointer = AsyncSqliteSaver(conn)
    return _consultant_checkpointer


async def get_consultant_agent():
    """
    è·å–æˆ–åˆ›å»ºå¸¦ checkpointer çš„ Agentï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
    
    è¿™ä¸ªå‡½æ•°ç¡®ä¿ Agent åªåˆ›å»ºä¸€æ¬¡ï¼Œå¹¶ä¸”ä½¿ç”¨å¼‚æ­¥ checkpointer
    """
    global _consultant_agent_with_checkpointer
    if _consultant_agent_with_checkpointer is None:
        checkpointer = await get_consultant_checkpointer()
        _consultant_agent_with_checkpointer = create_react_agent(
            model=openai_llm,
            tools=consultant_tools,
            prompt=CONSULTANT_AGENT_PROMPT,
            checkpointer=checkpointer
        )
    return _consultant_agent_with_checkpointer